[gd_scene load_steps=7 format=2]

[ext_resource path="res://2D/Tiles/manizales-colombia.png" type="Texture" id=1]
[ext_resource path="res://Code/Map Code/MapGenerator.gd" type="Script" id=2]
[ext_resource path="res://Code/Map Code/Variables.gd" type="Script" id=3]
[ext_resource path="res://Scenes/GUI/GUI.tscn" type="PackedScene" id=4]

[sub_resource type="Shader" id=1]
code = "shader_type canvas_item;

uniform float boost : hint_range(1.0, 1.5, 0.01) = float(1.2);
uniform float grille_opacity : hint_range(0.0, 1.0, 0.01) = float(0.85);
uniform float scanlines_opacity : hint_range(0.0, 1.0, 0.01) = float(0.95);
uniform float vignette_opacity : hint_range(0.1, 0.5, 0.01) = float(0.2);
uniform float scanlines_speed : hint_range(0.0, 1.0, 0.01) = float(1.0);
uniform bool show_grille = true; // Grille only works in Stretch Mode: 2D.
uniform bool show_scanlines = true;
uniform bool show_vignette = true;
uniform bool show_curvature = true;
uniform vec2 screen_size = vec2(320.0, 180.0);

vec2 CRTCurveUV(vec2 uv) {
	if(show_curvature) {
		uv = uv * 2.0 - 1.0;
		vec2 offset = abs(uv.yx) / vec2(6.0, 4.0);
		uv = uv + uv * offset * offset;
		uv = uv * 0.5 + 0.5;
	}
	return uv;
}

void DrawVignette(inout vec3 color, vec2 uv) {
	if(show_vignette) {
		float vignette = uv.x * uv.y * (1.0 - uv.x) * (1.0 - uv.y);
		vignette = clamp(pow(16.0 * vignette, vignette_opacity), 0.0, 1.0);
		color *= vignette;
	} else {
		return;
	}
}

void DrawScanline(inout vec3 color, vec2 uv, float time) {
	float scanline = clamp((scanlines_opacity - 0.05) + 0.05 * sin(3.1415926535 * (uv.y + 0.008 * time) * screen_size.y), 0.0, 1.0);
	float grille = (grille_opacity - 0.15) + 0.15 * clamp(1.5 * sin(3.1415926535 * uv.x * screen_size.x), 0.0, 1.0);

	if (show_scanlines) {
		color *= scanline;
	}

	if (show_grille) {
		color *= grille;
	}

	color *= boost;
}

void fragment() {
	vec2 screen_crtUV = CRTCurveUV(SCREEN_UV);
	vec3 color = texture(SCREEN_TEXTURE, screen_crtUV).rgb;
	
	vec2 crtUV = CRTCurveUV(UV);
	if (crtUV.x < 0.0 || crtUV.x > 1.0 || crtUV.y < 0.0 || crtUV.y > 1.0) {
		color = vec3(0.0, 0.0, 0.0);
	}
	
	DrawVignette(color, crtUV);
	DrawScanline(color, crtUV, TIME * scanlines_speed);
	
	COLOR = vec4(color, 1.0);
}"

[sub_resource type="ShaderMaterial" id=2]
shader = SubResource( 1 )
shader_param/boost = 1.2
shader_param/grille_opacity = 0.85
shader_param/scanlines_opacity = 0.95
shader_param/vignette_opacity = 0.2
shader_param/scanlines_speed = 1.0
shader_param/show_grille = true
shader_param/show_scanlines = true
shader_param/show_vignette = true
shader_param/show_curvature = true
shader_param/screen_size = Vector2( 320, 180 )

[node name="Map" type="Node2D"]
__meta__ = {
"_edit_lock_": true
}

[node name="manizales-colombia" type="Sprite" parent="."]
modulate = Color( 1, 1, 1, 0.145098 )
position = Vector2( 176.247, 34.9537 )
scale = Vector2( 1.02341, 0.716387 )
texture = ExtResource( 1 )
__meta__ = {
"_edit_lock_": true
}

[node name="Ground" type="Node2D" parent="."]

[node name="YSort" type="YSort" parent="."]

[node name="Scripts" type="Node" parent="."]

[node name="Map" type="Node" parent="Scripts"]
script = ExtResource( 2 )

[node name="Variables" type="Node" parent="Scripts"]
script = ExtResource( 3 )

[node name="GUI" parent="." instance=ExtResource( 4 )]
position = Vector2( 1.7064, -6.82561 )

[node name="CRT" type="CanvasLayer" parent="."]

[node name="ColorRect" type="ColorRect" parent="CRT"]
material = SubResource( 2 )
margin_left = -2.0
margin_top = -2.0
margin_right = 353.0
margin_bottom = 258.0
__meta__ = {
"_edit_lock_": true
}
