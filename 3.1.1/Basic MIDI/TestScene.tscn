[gd_scene load_steps=4 format=2]

[ext_resource path="res://addons/midi/MidiPlayer.gd" type="Script" id=1]
[ext_resource path="res://addons/midi/icon.png" type="Texture" id=2]

[sub_resource type="GDScript" id=1]
script/source = "extends Node

onready var midi_player = $GodotMIDIPlayer
var tempo_changing = false
var ui_channels
var SMF = preload( \"res://addons/midi/SMF.gd\" )
var file = \"\"

var names = load(\"res://Scripts/MIDInames.gd\")
var midi_names

\"\"\"
	Initializes
\"\"\"
func _ready( ):
	midi_names = names.new()
	#self._setup_channel_status_viewers( )
	$GodotMIDIPlayer.connect( \"midi_event\", self, \"_on_midi_event\" )

func Add_Labels():
	for i in range(0, len($Channels.get_children())):
		$Channels.get_child(i).queue_free()
		
	ui_channels = []
	
	for i in range(0, self.midi_player.max_channel):
		var channel_label = Label.new()
		channel_label.text = \"Empty Channel\" 
		ui_channels.append(channel_label)
		$Channels.add_child(channel_label)
	
	print(self.midi_player.max_channel)


func _setup_channel_status_viewers( ):
	#for i in range( 0, len( self.midi_player.channel_status ) ):
	#	var status = CheckBox.new( )
	#	status.pressed = false
	#	self.ui_channels.append( status )
	#	$VBoxContainer.add_child( status )
	pass

\"\"\"
	Process
\"\"\"
func _process( delta:float ):
	self._process_update_apply_ui( )
	#self._process_update_channel_status( )

func _process_update_apply_ui( ):
	# Update some values
	self.midi_player.play_speed = $VBoxContainer/HBoxContainer/PlaySpeedBar.value
	self.midi_player.volume_db = $VBoxContainer/HBoxContainer2/VolumeBar.value
	self.midi_player.loop = $VBoxContainer/HBoxContainer3/Loop.pressed

	# Update seek bar
	$VBoxContainer/HBoxContainer4/SeekBar.min_value = 0
	$VBoxContainer/HBoxContainer4/SeekBar.max_value = self.midi_player.last_position
	$VBoxContainer/HBoxContainer4/SeekBar.value = self.midi_player.position

	# Update tempo line edit
	if not self.tempo_changing:
		$VBoxContainer/HBoxContainer3/Tempo.text = str( self.midi_player.tempo )

	# Update polyphony status text
	$VBoxContainer/PolyphonyStatus.text = (
		( \"polyphony %d / %d\" % [
			self.midi_player.get_now_playing_polyphony( ),
			self.midi_player.max_polyphony
		] )
	)

func _process_update_channel_status( ):
	for i in range( 0, len( self.midi_player.channel_status ) ):
		var channel = self.midi_player.channel_status[i]
		var checkbox = self.ui_channels[i]

		# Set channel mute
		self.midi_player.channel_mute[i] = checkbox.pressed

		# Get the channel information and Display it
		checkbox.text = \"CH%2d program:#%3d notes:%2d volume:%8.5f expression:%8.5f pan:%8.5f pitch:%8.5f\" % [
			i,
			channel.program,
			len( channel.note_on.keys( ) ),
			channel.volume,
			channel.expression,
			channel.pan,
			channel.pitch_bend,
		]

\"\"\"
	Signals
\"\"\"
func _on_ui_seek_bar_scrolling( ):
	if not self.midi_player.playing:
		self.midi_player.play( )
	self.midi_player.seek( $VBoxContainer/HBoxContainer4/SeekBar.value )

func _on_ui_tempo_focus_entered( ):
	self.tempo_changing = true

func _on_ui_tempo_focus_exited( ):
	self.tempo_changing = false

func _on_ui_tempo_entered( o ):
	var bpm:int = int( $VBoxContainer/HBoxContainer3/Tempo.text )
	if 0 <= bpm:
		self.midi_player.tempo = bpm

func _on_OpenButton_pressed( ):
	$FileDialog.visible = true

func _on_FileDialog_file_selected( path ):
	$GodotMIDIPlayer.stop( )
	file = path
	$GodotMIDIPlayer.file = file
	$VBoxContainer/HBoxContainer/PlaySpeedBar.value = 1.0
	Add_Labels()

func _on_midi_event( channel, event ):
	# channel is same as $GodotMidiPlayer.channel_status[track_id]
	# event is event parameter. see SMF.gd and MidiPlayer.gd

	#if not $VBoxContainer/HBoxContainer3/OutputEvent.pressed: return
	
	# Output event data to stdout
	var event_string = \"\"
	match event.type:
		SMF.MIDIEventType.note_off:
			event_string = \"NoteOff %d\" % event.note
		SMF.MIDIEventType.note_on:
			event_string = \"NoteOn %d\" % event.note
		#SMF.MIDIEventType.program_change:
			#event_string = \"ProgramChange %d\" % event.number
		#SMF.MIDIEventType.control_change:
		#	event_string = \"ControlChange %d\" % event.number
		#SMF.MIDIEventType.pitch_bend:
		#	event_string = \"PitchBend %d\" % event.value
		#SMF.MIDIEventType.system_event:
		#	event_string = \"SystemEvent %d\" % event.args.type
	
	if channel.number == 9  and event.type == SMF.MIDIEventType.note_on:
		ui_channels[channel.number].text = \"PERCUSSION \" + str(\"\") + \" : \" + str(midi_names.percussion[event.note])
	else:
		ui_channels[channel.number].text = \"CHANNEL \" + str(midi_names.instrument[channel.program]) + \" : \" + event_string
	
	#print( channel, event, \"channel:%d event-type:%s\" % [
	#	channel.number,
	#	event_string,
	#])


func _on_Play_pressed():
	if file != \"\":
		self.midi_player.play( )


func _on_STOP_pressed():
	self.midi_player.stop()
"

[node name="TestScene" type="Node"]
script = SubResource( 1 )

[node name="GodotMIDIPlayer" type="Node" parent="."]
script = ExtResource( 1 )
__meta__ = {
"_editor_icon": ExtResource( 2 )
}
file = "res://data/awakenin.mid"
playing = true
soundfont = "res://data/Aspirin-Stereo.sf2"
bus = "Rev"

[node name="VBoxContainer" type="VBoxContainer" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = 8.0
margin_top = 8.0
margin_right = -8.0
margin_bottom = -8.0
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="Label" type="Label" parent="VBoxContainer"]
margin_right = 1008.0
margin_bottom = 14.0
text = "Godot MIDI Player Library Test:"

[node name="HBoxContainer3" type="HBoxContainer" parent="VBoxContainer"]
margin_top = 18.0
margin_right = 1008.0
margin_bottom = 42.0

[node name="OpenButton" type="Button" parent="VBoxContainer/HBoxContainer3"]
margin_right = 47.0
margin_bottom = 24.0
text = "Open"

[node name="PLAY" type="Button" parent="VBoxContainer/HBoxContainer3"]
margin_left = 51.0
margin_right = 94.0
margin_bottom = 24.0
text = "PLAY"

[node name="STOP" type="Button" parent="VBoxContainer/HBoxContainer3"]
margin_left = 98.0
margin_right = 143.0
margin_bottom = 24.0
text = "STOP"

[node name="Loop" type="CheckBox" parent="VBoxContainer/HBoxContainer3"]
margin_left = 147.0
margin_right = 206.0
margin_bottom = 24.0
text = "Loop"

[node name="Label6" type="Label" parent="VBoxContainer/HBoxContainer3"]
margin_left = 210.0
margin_top = 5.0
margin_right = 254.0
margin_bottom = 19.0
text = "Tempo"

[node name="Tempo" type="LineEdit" parent="VBoxContainer/HBoxContainer3"]
margin_left = 258.0
margin_right = 316.0
margin_bottom = 24.0

[node name="OutputEvent" type="CheckBox" parent="VBoxContainer/HBoxContainer3"]
visible = false
margin_left = 224.0
margin_right = 405.0
margin_bottom = 24.0
text = "Output Events to Stdout"

[node name="HBoxContainer" type="HBoxContainer" parent="VBoxContainer"]
editor/display_folded = true
margin_top = 46.0
margin_right = 1008.0
margin_bottom = 60.0
size_flags_horizontal = 3

[node name="Label2" type="Label" parent="VBoxContainer/HBoxContainer"]
margin_right = 65.0
margin_bottom = 14.0
text = "PlaySpeed"

[node name="PlaySpeedBar" type="HScrollBar" parent="VBoxContainer/HBoxContainer"]
margin_left = 69.0
margin_right = 1008.0
margin_bottom = 14.0
size_flags_horizontal = 3
size_flags_vertical = 3
max_value = 2.0
value = 1.0

[node name="HBoxContainer2" type="HBoxContainer" parent="VBoxContainer"]
editor/display_folded = true
margin_top = 64.0
margin_right = 1008.0
margin_bottom = 78.0
size_flags_horizontal = 3

[node name="Label3" type="Label" parent="VBoxContainer/HBoxContainer2"]
margin_right = 49.0
margin_bottom = 14.0
text = "Volume"

[node name="VolumeBar" type="HScrollBar" parent="VBoxContainer/HBoxContainer2"]
margin_left = 53.0
margin_right = 1008.0
margin_bottom = 14.0
size_flags_horizontal = 3
size_flags_vertical = 3
min_value = -50.0
max_value = -10.0
value = -30.0

[node name="HBoxContainer4" type="HBoxContainer" parent="VBoxContainer"]
editor/display_folded = true
margin_top = 82.0
margin_right = 1008.0
margin_bottom = 96.0

[node name="Label4" type="Label" parent="VBoxContainer/HBoxContainer4"]
margin_right = 30.0
margin_bottom = 14.0
text = "Seek"

[node name="SeekBar" type="HScrollBar" parent="VBoxContainer/HBoxContainer4"]
margin_left = 34.0
margin_right = 1008.0
margin_bottom = 12.0
size_flags_horizontal = 3

[node name="PolyphonyStatus" type="Label" parent="VBoxContainer"]
margin_top = 100.0
margin_right = 1008.0
margin_bottom = 114.0
text = "Polyphony Status"

[node name="Label5" type="Label" parent="VBoxContainer"]
margin_top = 118.0
margin_right = 1008.0
margin_bottom = 132.0
text = "Channel / Mute"

[node name="FileDialog" type="FileDialog" parent="."]
margin_left = 242.0
margin_top = 102.0
margin_right = 767.0
margin_bottom = 447.0
window_title = "Abrir un archivo"
mode = 0
access = 2
filters = PoolStringArray( "*.mid" )
current_dir = "/home/cristian/Documentos/Github/Godot/3.1.1/Basic MIDI"
current_path = "/home/cristian/Documentos/Github/Godot/3.1.1/Basic MIDI/"

[node name="Channels" type="VBoxContainer" parent="."]
margin_left = 7.0
margin_top = 154.0
margin_right = 710.0
margin_bottom = 590.0
[connection signal="pressed" from="VBoxContainer/HBoxContainer3/OpenButton" to="." method="_on_OpenButton_pressed"]
[connection signal="pressed" from="VBoxContainer/HBoxContainer3/PLAY" to="." method="_on_Play_pressed"]
[connection signal="pressed" from="VBoxContainer/HBoxContainer3/STOP" to="." method="_on_STOP_pressed"]
[connection signal="focus_entered" from="VBoxContainer/HBoxContainer3/Tempo" to="." method="_on_ui_tempo_focus_entered"]
[connection signal="focus_exited" from="VBoxContainer/HBoxContainer3/Tempo" to="." method="_on_ui_tempo_focus_exited"]
[connection signal="text_entered" from="VBoxContainer/HBoxContainer3/Tempo" to="." method="_on_ui_tempo_entered"]
[connection signal="scrolling" from="VBoxContainer/HBoxContainer4/SeekBar" to="." method="_on_ui_seek_bar_scrolling"]
[connection signal="file_selected" from="FileDialog" to="." method="_on_FileDialog_file_selected"]
